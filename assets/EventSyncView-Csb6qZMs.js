import{n as h,D as P,d as x,G as W,o as d,a as u,k as e,F as I,l as M,f as V,H as L,y as f,p as F,j as B,M as Y,_ as H,c as T,C as z,X as O,b as C,h as J,e as q,q as G,s as N,m as R}from"./index-C3usxq6_.js";import{e as D}from"./events-DVSK9dFx.js";function X(){const c=h([]),m=h(!1),o=h(!1),v=h(null);let g=null,l=!1;const w=(p,_)=>{i(),v.value=null,l=!1,g=new EventSource(p),m.value=!0,o.value=!0,g.onmessage=n=>{console.log("SSE message:",n)},Object.keys(_).forEach(n=>{g.addEventListener(n,y=>{const E=JSON.parse(y.data);n!=="heartbeat"&&c.value.push({timestamp:new Date().toLocaleTimeString("de-DE"),event:n,message:E.message,data:E}),(n.includes("complete")||n.includes("error"))&&(l=!0),_[n](E)})}),g.onerror=n=>{console.error("SSE error:",n),setTimeout(()=>{if(!l&&m.value){const y="SSE connection error: The connection to the server was lost or timed out. The operation may have been interrupted.";v.value=y,c.value.push({timestamp:new Date().toLocaleTimeString("de-DE"),event:"error",message:y,data:n})}o.value=!1,i()},300)}},i=()=>{g&&(g.close(),g=null,m.value=!1,o.value=!1)},b=()=>{c.value=[]},k=()=>{v.value=null};return P(()=>{i()}),{logs:c,isConnected:m,isLoading:o,error:v,connect:w,disconnect:i,clearLogs:b,clearError:k}}const U=c=>(F("data-v-f2ad544f"),c=c(),B(),c),K={class:"sync-log"},Q=U(()=>e("h2",null,"Sync Log",-1)),Z={class:"log-timestamp"},ee={class:"log-message"},te={key:0,class:"empty-state"},se=U(()=>e("p",null,"No log entries yet. Start a sync operation to see progress.",-1)),oe=[se],le=x({__name:"EventSyncLog",props:{logs:{}},setup(c){const m=c,o=h(null);W(()=>m.logs.length,async()=>{await Y(),o.value&&(o.value.scrollTop=o.value.scrollHeight)});function v(l){return l.includes("error")?"log-error":l.includes("complete")?"log-success":l.includes("start")?"log-info":"log-default"}function g(l){return l.includes("error")?"badge-error":l.includes("complete")?"badge-success":l.includes("start")?"badge-info":l==="heartbeat"?"badge-heartbeat":"badge-default"}return(l,w)=>(d(),u("div",K,[Q,e("div",{class:"log-container",ref_key:"logContainer",ref:o},[(d(!0),u(I,null,M(l.logs,(i,b)=>(d(),u("div",{class:L(["log-entry",v(i.event)]),key:b},[e("div",Z,f(i.timestamp),1),e("div",{class:L(["log-badge",g(i.event)])},f(i.event),3),e("div",ee,f(i.message),1)],2))),128)),l.logs.length===0?(d(),u("div",te,oe)):V("",!0)],512)]))}}),ne=H(le,[["__scopeId","data-v-f2ad544f"]]),S=c=>(F("data-v-e8d7ed9c"),c=c(),B(),c),ae={class:"event-sync"},ce=S(()=>e("h1",null,"Event Synchronization",-1)),ie={key:0,class:"error-banner"},re={class:"error-content"},de=S(()=>e("strong",null,"SSE Connection Error:",-1)),ue={class:"actions mb-2"},ge=["disabled"],ve={key:0},_e={key:1},he={class:"event-list mb-2"},me=S(()=>e("h2",null,"Events",-1)),pe={class:"select-all-container mb-1"},fe={class:"checkbox-label"},ye={key:0,class:"table-container"},be={class:"event-table"},Se=S(()=>e("thead",null,[e("tr",null,[e("th",{class:"col-select"}),e("th",{class:"col-id"},"ID"),e("th",{class:"col-date"},"Date"),e("th",{class:"col-title"},"Title")])],-1)),we={class:"col-select"},Ee=["value"],ke={class:"col-id"},Ce={class:"col-date"},De={class:"col-title"},We={key:1,class:"loading"},$e=S(()=>e("p",null,"Loading events...",-1)),Le=[$e],Te={key:2,class:"empty-state"},Ge=S(()=>e("p",null,"No events found in the database.",-1)),Ne=[Ge],xe=["disabled"],Ie={key:0},Me={key:1},Ve=x({__name:"EventSyncView",setup(c){const m=h(null),o=h([]),v=h(!1),{logs:g,error:l,connect:w,disconnect:i,clearLogs:b,clearError:k}=X(),p=h(!1),_=h(!1),n=T(()=>{var r;return((r=m.value)==null?void 0:r.results)||[]}),y=T({get:()=>o.value.length===n.value.length&&n.value.length>0,set:r=>{r?o.value=n.value.map(a=>a.id):o.value=[]}});z(async()=>{await $()});async function $(){try{v.value=!0,m.value=await D.getAll();const r=new Set(O.map(a=>a.id));o.value=n.value.filter(a=>r.has(a.id)).map(a=>a.id)}catch(r){console.error("Failed to load events:",r),alert("Failed to load events. Please check your connection.")}finally{v.value=!1}}function E(){if(!confirm("This will sync events from the git submodule to the database. Continue?"))return;p.value=!0,b(),k();const r=D.getSyncFromGitUrl();w(r,{sync_start:t=>{console.log("Sync started:",t)},git_pull:t=>{console.log("Git pull:",t)},artist_sync:t=>{console.log("Artist synced:",t)},event_sync:t=>{console.log("Event synced:",t)},heartbeat:t=>{console.log("Heartbeat:",t)},sync_complete:t=>{console.log("Sync complete:",t),p.value=!1,i(),setTimeout(()=>{confirm("Sync completed successfully! Reload page to see updated events?")&&window.location.reload()},500)},sync_error:t=>{console.error("Sync error:",t),p.value=!1,i(),alert(`Sync failed: ${t.message}`)}});const a=W(l,t=>{t&&(p.value=!1,alert(`Connection error during sync: ${t}`),a())})}function j(){if(o.value.length===0){alert("Please select at least one event to write to the website.");return}const r=`This will write ${o.value.length} event(s) to the website, commit, push, and deploy. This may take several minutes. Continue?`;if(!confirm(r))return;_.value=!0,b(),k();const a=D.getWriteToWebsiteUrl(o.value);w(a,{write_start:s=>{console.log("Write started:",s)},processing:s=>{console.log("Processing:",s)},git_pull:s=>{console.log("Git pull:",s)},json_write:s=>{console.log("JSON written:",s)},git_add:s=>{console.log("Git add:",s)},git_commit:s=>{console.log("Git commit:",s)},git_push:s=>{console.log("Git push:",s)},npm_deploy:s=>{console.log("NPM deploy (this may take a while):",s)},heartbeat:s=>{console.log("Heartbeat:",s)},write_complete:s=>{console.log("Write complete:",s),_.value=!1,i(),alert("Events successfully written and deployed to the website!")},write_error:s=>{console.error("Write error:",s),_.value=!1,i(),alert(`Write failed: ${s.message}`)}});const t=W(l,s=>{s&&(_.value=!1,alert(`Connection error during write: ${s}`),t())})}function A(r){return R(r).format("DD.MM.YYYY HH:mm")}return(r,a)=>(d(),u("div",ae,[ce,C(l)?(d(),u("div",ie,[e("div",re,[de,J(" "+f(C(l)),1)])])):V("",!0),e("div",ue,[e("button",{class:"btn-primary",onClick:j,disabled:p.value||_.value||o.value.length===0},[_.value?(d(),u("span",_e,"Writing...")):(d(),u("span",ve,"Write to Website ("+f(o.value.length)+" selected)",1))],8,ge)]),q(ne,{logs:C(g)},null,8,["logs"]),e("div",he,[me,e("div",pe,[e("label",fe,[G(e("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=t=>y.value=t)},null,512),[[N,y.value]]),e("span",null,"Select All ("+f(n.value.length)+" events)",1)])]),n.value.length>0?(d(),u("div",ye,[e("table",be,[Se,e("tbody",null,[(d(!0),u(I,null,M(n.value,t=>(d(),u("tr",{key:t.id},[e("td",we,[G(e("input",{type:"checkbox",value:t.id,"onUpdate:modelValue":a[1]||(a[1]=s=>o.value=s)},null,8,Ee),[[N,o.value]])]),e("td",ke,f(t.id),1),e("td",Ce,f(A(t.date)),1),e("td",De,f(t.title),1)]))),128))])])])):v.value?(d(),u("div",We,Le)):(d(),u("div",Te,Ne))]),e("button",{class:"btn-primary",onClick:E,disabled:p.value||_.value},[p.value?(d(),u("span",Me,"Syncing...")):(d(),u("span",Ie,"Sync from Git ( Diesen Button nur benutzen wenn ihr wisst was ihr tut)"))],8,xe)]))}}),He=H(Ve,[["__scopeId","data-v-e8d7ed9c"]]);export{He as default};
